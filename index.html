<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline';">

    <title>ç·šä¸ŠåŠ è§£å¯†å·¥å…· | Online Text Encryption & Decryption (AES-GCM-256)</title>

    <meta name="description" content="å°ˆæ¥­ç·šä¸Šæ–‡å­—åŠ è§£å¯†å·¥å…·ã€‚æ¡ç”¨ AES-GCM-256 é«˜å¼·åº¦æ¼”ç®—æ³•ï¼Œæ‰€æœ‰åŠ è§£å¯†ç¨‹åºçš†åœ¨ç€è¦½å™¨æœ¬åœ°å®Œæˆï¼Œæ‚¨çš„æ•æ„Ÿæ•¸æ“šçµ•ä¸å‚³è¼¸è‡³ä¼ºæœå™¨ï¼Œç¢ºä¿ 100% éš±ç§ã€‚">
    <meta name="keywords" content="ç·šä¸ŠåŠ å¯†, ç·šä¸Šè§£å¯†, æ–‡å­—åŠ å¯†, AES-256-GCM, éš±ç§ä¿è­·, Online Encryption, AES Vault">
    <meta name="author" content="mike-hsieh-tw">

    <meta property="og:title" content="ç·šä¸ŠåŠ è§£å¯†å·¥å…· - AES Vault (AES-GCM-256)">
    <meta property="og:description" content="ç¢ºä¿éš±ç§çš„æœ¬åœ°åŒ–åŠ è§£å¯†å·¥å…·ï¼Œæ•¸æ“šä¸é›¢é–‹ç™¼é€ç«¯ï¼Œå®‰å…¨å¯é ã€‚">
    <meta property="og:url" content="https://mike-hsieh-tw.github.io/aes-vault/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="AES Vault">

    <link rel="canonical" href="https://mike-hsieh-tw.github.io/aes-vault/">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .security-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.85em;
        }

        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            margin-bottom: 20px;
        }

        /* æ¨¡å¼åˆ‡æ› Tab */
        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .mode-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            position: relative;
            bottom: -2px;
        }

        .mode-tab:hover {
            color: #667eea;
        }

        .mode-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .mode-tab .icon {
            font-size: 1.2em;
            margin-right: 8px;
        }

        /* è¡¨å–®å€åŸŸ */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }

        textarea, input[type="password"], input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: sans-serif;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            line-height: 1.5;
            font-family: sans-serif;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .password-wrapper {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            padding: 5px 10px;
            font-weight: 500;
        }

        .toggle-password:hover {
            color: #764ba2;
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        .strength-weak { background-color: #f44336; width: 33%; }
        .strength-medium { background-color: #ff9800; width: 66%; }
        .strength-strong { background-color: #4caf50; width: 100%; }

        .password-hint {
            font-size: 0.85em;
            color: #888;
            margin-top: 6px;
        }

        /* æŒ‰éˆ• */
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }

        button {
            padding: 14px 28px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
            min-width: 100px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        button:active:not(:disabled) {
            transform: translateY(0px);
        }

        /* è¼¸å‡ºå€åŸŸ */
        .output-section {
            margin-top: 30px;
        }

        .output-area {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 18px;
            min-height: 100px;
            font-family: sans-serif;
            font-size: 0.95em;
            word-break: break-all;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #333;
        }

        .output-area.empty {
            color: #999;
            font-style: italic;
        }

        .output-area.success {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .output-area.error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        /* Loading å‹•ç•« */
        .loading {
            display: none;
            text-align: center;
            padding: 30px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #667eea;
            font-weight: 500;
        }

        /* è³‡è¨Šæ¡† */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 18px;
            border-radius: 5px;
            margin-top: 30px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
            color: #1976d2;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 0.85em;
            opacity: 0.85;
            line-height: 1.6;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .main-card {
                padding: 25px;
            }

            .header h1 {
                font-size: 2em;
            }

            .header .subtitle {
                font-size: 0.85em;
            }

            .mode-tab {
                font-size: 1em;
                padding: 12px;
            }

            textarea {
                min-height: 120px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” é«˜å®‰å…¨æ€§åŠ è§£å¯†å·¥å…·</h1>
            <div class="subtitle">AES-GCM-256 + PBKDF2-SHA512 (600k iterations) + HKDF</div>
            <div class="security-badge">âœ“ é›¶å¤–éƒ¨ä¾è³´ | âœ“ å®Œå…¨é›¢ç·š | âœ“ å®¢æˆ¶ç«¯åŠ å¯†</div>
        </div>

        <div class="main-card">
            <!-- æ¨¡å¼åˆ‡æ› Tab -->
            <div class="mode-tabs">
                <button class="mode-tab active" onclick="switchMode('encrypt')" id="encrypt-tab">
                    <span class="icon">ğŸ”’</span>åŠ å¯†
                </button>
                <button class="mode-tab" onclick="switchMode('decrypt')" id="decrypt-tab">
                    <span class="icon">ğŸ”“</span>è§£å¯†
                </button>
            </div>

            <!-- è¼¸å…¥å…§å®¹å€ -->
            <div class="form-group">
                <label for="content-input" id="content-label">è¼¸å…¥å…§å®¹</label>
                <textarea id="content-input" placeholder="è«‹è¼¸å…¥è¦åŠ å¯†çš„å…§å®¹..."></textarea>
            </div>

            <!-- å¯†ç¢¼è¼¸å…¥å€ -->
            <div class="form-group">
                <label for="password-input">å¯†ç¢¼</label>
                <div class="password-wrapper">
                    <input type="password" id="password-input" placeholder="è¼¸å…¥å¼·å¯†ç¢¼ï¼ˆå»ºè­°16å­—å…ƒä»¥ä¸Šï¼‰">
                    <button type="button" class="toggle-password" onclick="togglePassword()">é¡¯ç¤º</button>
                </div>
                <div class="password-strength">
                    <div id="password-strength-bar" class="password-strength-bar"></div>
                </div>
                <div class="password-hint" id="password-hint">å»ºè­°ï¼šè‡³å°‘12å­—å…ƒï¼ŒåŒ…å«å¤§å°å¯«ã€æ•¸å­—ã€ç‰¹æ®Šç¬¦è™Ÿ</div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="button-group">
                <button class="btn-primary" onclick="processAction()" id="action-button">
                    ğŸ”’ åŠ å¯†
                </button>
                <button class="btn-secondary" onclick="clearAll()">æ¸…é™¤</button>
            </div>

            <!-- Loading å‹•ç•« -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text" id="loading-text">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
            </div>

            <!-- çµæœè¼¸å‡ºå€ -->
            <div class="output-section" id="output-section" style="display: none;">
                <div class="form-group">
                    <label id="output-label">çµæœ</label>
                    <div id="output" class="output-area empty">çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
                    <div class="button-group" style="margin-top: 12px;">
                        <button class="btn-success" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½çµæœ</button>
                    </div>
                </div>
            </div>

            <!-- è³‡è¨Šèªªæ˜ -->
            <div class="info-box">
                <strong>âš ï¸ å®‰å…¨æç¤º</strong>
                â€¢ æ‰€æœ‰åŠ å¯†è™•ç†å®Œå…¨åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬åœ°å®Œæˆï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨<br>
                â€¢ è«‹å¦¥å–„ä¿ç®¡æ‚¨çš„å¯†ç¢¼ï¼Œéºå¤±å¯†ç¢¼å°‡ç„¡æ³•å¾©åŸè³‡æ–™<br>
                â€¢ æ­¤å·¥å…·ä½¿ç”¨ AES-GCM-256 ä½å…ƒåŠ å¯†ï¼ŒPBKDF2-SHA512 (600,000 æ¬¡è¿­ä»£) é‡‘é‘°è¡ç”Ÿ<br>
                â€¢ å»ºè­°ä½¿ç”¨å¼·å¯†ç¢¼ä»¥ç²å¾—æœ€ä½³å®‰å…¨æ€§
            </div>
        </div>

        <div class="footer">
            <p>100% åŸç”Ÿ JavaScript å¯¦ä½œ | é›¶å¤–éƒ¨ä¾è³´ | é–‹æºå¯å¯©è¨ˆ</p>
            <p>Version 1.0 | AES-GCM-256 | PBKDF2-SHA512 | HKDF-SHA256</p>
        </div>
    </div>

    <script>
        'use strict';

        // ============================================
        // å¸¸æ•¸å®šç¾©
        // ============================================
        const CONFIG = {
            VERSION: 0x01,
            SALT_SIZE: 32,
            IV_SIZE: 12,
            PBKDF2_ITERATIONS: 600000,
            AES_KEY_SIZE: 256,
            HASH_ALGORITHM: 'SHA-512',
            HKDF_HASH: 'SHA-256'
        };

        // ç•¶å‰æ¨¡å¼ï¼ˆencrypt æˆ– decryptï¼‰
        let currentMode = 'encrypt';

        // ============================================
        // Base64 ç·¨ç¢¼/è§£ç¢¼ (è™•ç† Unicode)
        // ============================================
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // ============================================
        // HKDF-SHA256 å¯¦ä½œ
        // ============================================
        async function hkdf(ikm, length, salt = null, info = '') {
            // HKDF-Extract
            const saltKey = await crypto.subtle.importKey(
                'raw',
                salt || new Uint8Array(32),
                { name: 'HMAC', hash: CONFIG.HKDF_HASH },
                false,
                ['sign']
            );

            const prk = await crypto.subtle.sign('HMAC', saltKey, ikm);

            // HKDF-Expand
            const prkKey = await crypto.subtle.importKey(
                'raw',
                prk,
                { name: 'HMAC', hash: CONFIG.HKDF_HASH },
                false,
                ['sign']
            );

            const infoBytes = new TextEncoder().encode(info);
            const hashLen = 32; // SHA-256 è¼¸å‡º 32 bytes
            const n = Math.ceil(length / hashLen);

            let t = new Uint8Array(0);
            let okm = new Uint8Array(0);

            for (let i = 0; i < n; i++) {
                const data = new Uint8Array(t.length + infoBytes.length + 1);
                data.set(t);
                data.set(infoBytes, t.length);
                data[data.length - 1] = i + 1;

                t = new Uint8Array(await crypto.subtle.sign('HMAC', prkKey, data));

                const newOkm = new Uint8Array(okm.length + t.length);
                newOkm.set(okm);
                newOkm.set(t, okm.length);
                okm = newOkm;
            }

            return okm.slice(0, length);
        }

        // ============================================
        // UI æ§åˆ¶å‡½æ•¸
        // ============================================
        function switchMode(mode) {
            currentMode = mode;

            const encryptTab = document.getElementById('encrypt-tab');
            const decryptTab = document.getElementById('decrypt-tab');
            const contentLabel = document.getElementById('content-label');
            const contentInput = document.getElementById('content-input');
            const passwordHint = document.getElementById('password-hint');
            const actionButton = document.getElementById('action-button');

            if (mode === 'encrypt') {
                encryptTab.classList.add('active');
                decryptTab.classList.remove('active');
                contentLabel.textContent = 'è¼¸å…¥å…§å®¹';
                contentInput.placeholder = 'è«‹è¼¸å…¥è¦åŠ å¯†çš„å…§å®¹...';
                passwordHint.textContent = 'å»ºè­°ï¼šè‡³å°‘12å­—å…ƒï¼ŒåŒ…å«å¤§å°å¯«ã€æ•¸å­—ã€ç‰¹æ®Šç¬¦è™Ÿ';
                actionButton.innerHTML = 'ğŸ”’ åŠ å¯†';
            } else {
                encryptTab.classList.remove('active');
                decryptTab.classList.add('active');
                contentLabel.textContent = 'å¯†æ–‡å…§å®¹';
                contentInput.placeholder = 'è«‹è²¼ä¸Šè¦è§£å¯†çš„å¯†æ–‡...';
                passwordHint.textContent = 'è«‹è¼¸å…¥åŠ å¯†æ™‚ä½¿ç”¨çš„å¯†ç¢¼';
                actionButton.innerHTML = 'ğŸ”“ è§£å¯†';
            }

            // æ¸…é™¤è¼¸å‡º
            hideOutput();
        }

        function hideOutput() {
            const outputSection = document.getElementById('output-section');
            outputSection.style.display = 'none';
        }

        function showOutput(content, type = 'success') {
            const outputSection = document.getElementById('output-section');
            const outputDiv = document.getElementById('output');
            const outputLabel = document.getElementById('output-label');

            outputSection.style.display = 'block';

            if (type === 'success') {
                outputDiv.textContent = content;
                outputDiv.className = 'output-area success';
                outputLabel.textContent = currentMode === 'encrypt' ? 'åŠ å¯†çµæœ' : 'è§£å¯†çµæœ';
            } else {
                outputDiv.textContent = 'âŒ ' + content;
                outputDiv.className = 'output-area error';
                outputLabel.textContent = 'éŒ¯èª¤';
            }

            // å¹³æ»‘æ»¾å‹•åˆ°çµæœ
            setTimeout(() => {
                outputSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // ============================================
        // å¯†ç¢¼å¼·åº¦æª¢æ¸¬
        // ============================================
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('password-strength-bar');

            if (!password || currentMode === 'decrypt') {
                strengthBar.className = 'password-strength-bar';
                return;
            }

            let strength = 0;

            // é•·åº¦æª¢æŸ¥
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (password.length >= 16) strength++;

            // è¤‡é›œåº¦æª¢æŸ¥
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            // è¨­å®šå¼·åº¦é¡¯ç¤º
            strengthBar.className = 'password-strength-bar';
            if (strength <= 3) {
                strengthBar.classList.add('strength-weak');
            } else if (strength <= 5) {
                strengthBar.classList.add('strength-medium');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        }

        // ============================================
        // å¯†ç¢¼é¡¯ç¤º/éš±è—åˆ‡æ›
        // ============================================
        function togglePassword() {
            const input = document.getElementById('password-input');
            const button = input.nextElementSibling;

            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'éš±è—';
            } else {
                input.type = 'password';
                button.textContent = 'é¡¯ç¤º';
            }
        }

        // ============================================
        // ä¸»è¦è™•ç†å‡½æ•¸ï¼ˆæ ¹æ“šæ¨¡å¼åŸ·è¡ŒåŠ å¯†æˆ–è§£å¯†ï¼‰
        // ============================================
        async function processAction() {
            if (currentMode === 'encrypt') {
                await encryptData();
            } else {
                await decryptData();
            }
        }

        // ============================================
        // æ ¸å¿ƒåŠ å¯†å‡½æ•¸
        // ============================================
        async function encryptData() {
            const content = document.getElementById('content-input').value;
            const password = document.getElementById('password-input').value;
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');

            // é©—è­‰è¼¸å…¥
            if (!content) {
                showOutput('è«‹è¼¸å…¥è¦åŠ å¯†çš„å…§å®¹', 'error');
                return;
            }

            if (!password) {
                showOutput('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
                return;
            }

            if (password.length < 8) {
                showOutput('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒï¼Œå»ºè­°ä½¿ç”¨ 16 å­—å…ƒä»¥ä¸Šçš„å¼·å¯†ç¢¼', 'error');
                return;
            }

            try {
                loading.classList.add('active');
                loadingText.textContent = 'åŠ å¯†è™•ç†ä¸­ï¼Œè«‹ç¨å€™...';
                hideOutput();

                // å»¶é²åŸ·è¡Œä»¥é¡¯ç¤º loading å‹•ç•«
                await new Promise(resolve => setTimeout(resolve, 100));

                // 1. ç”Ÿæˆéš¨æ©Ÿ Salt å’Œ IV
                const salt = crypto.getRandomValues(new Uint8Array(CONFIG.SALT_SIZE));
                const iv = crypto.getRandomValues(new Uint8Array(CONFIG.IV_SIZE));

                // 2. ä½¿ç”¨ PBKDF2-SHA512 å¾å¯†ç¢¼è¡ç”Ÿä¸­é–“é‡‘é‘°
                const passwordBytes = new TextEncoder().encode(password);
                const passwordKey = await crypto.subtle.importKey(
                    'raw',
                    passwordBytes,
                    'PBKDF2',
                    false,
                    ['deriveBits']
                );

                const intermediateKeyBits = await crypto.subtle.deriveBits(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: CONFIG.PBKDF2_ITERATIONS,
                        hash: CONFIG.HASH_ALGORITHM
                    },
                    passwordKey,
                    256
                );

                // 3. ä½¿ç”¨ HKDF è¡ç”Ÿæœ€çµ‚ AES é‡‘é‘°
                const finalKeyBytes = await hkdf(
                    new Uint8Array(intermediateKeyBits),
                    32,
                    salt,
                    'AES-GCM-256-Encryption-Key'
                );

                const aesKey = await crypto.subtle.importKey(
                    'raw',
                    finalKeyBytes,
                    { name: 'AES-GCM' },
                    false,
                    ['encrypt']
                );

                // 4. åŠ å¯†æ˜æ–‡
                const plaintextBytes = new TextEncoder().encode(content);
                const ciphertext = await crypto.subtle.encrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv,
                        tagLength: 128
                    },
                    aesKey,
                    plaintextBytes
                );

                // 5. çµ„åˆè¼¸å‡º: version(1) + salt(32) + iv(12) + ciphertext
                const output = new Uint8Array(1 + CONFIG.SALT_SIZE + CONFIG.IV_SIZE + ciphertext.byteLength);
                output[0] = CONFIG.VERSION;
                output.set(salt, 1);
                output.set(iv, 1 + CONFIG.SALT_SIZE);
                output.set(new Uint8Array(ciphertext), 1 + CONFIG.SALT_SIZE + CONFIG.IV_SIZE);

                // 6. è½‰æ›ç‚º Base64
                const base64Output = arrayBufferToBase64(output);

                showOutput(base64Output, 'success');

            } catch (error) {
                console.error('åŠ å¯†éŒ¯èª¤:', error);
                showOutput('åŠ å¯†éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥', 'error');
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============================================
        // æ ¸å¿ƒè§£å¯†å‡½æ•¸
        // ============================================
        async function decryptData() {
            const content = document.getElementById('content-input').value.trim();
            const password = document.getElementById('password-input').value;
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');

            // é©—è­‰è¼¸å…¥
            if (!content) {
                showOutput('è«‹è¼¸å…¥è¦è§£å¯†çš„å¯†æ–‡', 'error');
                return;
            }

            if (!password) {
                showOutput('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
                return;
            }

            try {
                loading.classList.add('active');
                loadingText.textContent = 'è§£å¯†è™•ç†ä¸­ï¼Œè«‹ç¨å€™...';
                hideOutput();

                // å»¶é²åŸ·è¡Œä»¥é¡¯ç¤º loading å‹•ç•«
                await new Promise(resolve => setTimeout(resolve, 100));

                // 1. è§£æ Base64
                let encryptedData;
                try {
                    encryptedData = new Uint8Array(base64ToArrayBuffer(content));
                } catch (e) {
                    throw new Error('ç„¡æ•ˆçš„å¯†æ–‡æ ¼å¼');
                }

                // 2. æª¢æŸ¥ç‰ˆæœ¬å’Œæœ€å°é•·åº¦
                const minLength = 1 + CONFIG.SALT_SIZE + CONFIG.IV_SIZE + 16; // 16 = æœ€å° GCM tag
                if (encryptedData.length < minLength) {
                    throw new Error('å¯†æ–‡é•·åº¦ä¸æ­£ç¢º');
                }

                const version = encryptedData[0];
                if (version !== CONFIG.VERSION) {
                    throw new Error('ä¸æ”¯æ´çš„åŠ å¯†ç‰ˆæœ¬');
                }

                // 3. æå– Salt, IV, Ciphertext
                const salt = encryptedData.slice(1, 1 + CONFIG.SALT_SIZE);
                const iv = encryptedData.slice(1 + CONFIG.SALT_SIZE, 1 + CONFIG.SALT_SIZE + CONFIG.IV_SIZE);
                const ciphertextBytes = encryptedData.slice(1 + CONFIG.SALT_SIZE + CONFIG.IV_SIZE);

                // 4. ä½¿ç”¨ç›¸åŒåƒæ•¸å¾å¯†ç¢¼è¡ç”Ÿä¸­é–“é‡‘é‘°
                const passwordBytes = new TextEncoder().encode(password);
                const passwordKey = await crypto.subtle.importKey(
                    'raw',
                    passwordBytes,
                    'PBKDF2',
                    false,
                    ['deriveBits']
                );

                const intermediateKeyBits = await crypto.subtle.deriveBits(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: CONFIG.PBKDF2_ITERATIONS,
                        hash: CONFIG.HASH_ALGORITHM
                    },
                    passwordKey,
                    256
                );

                // 5. ä½¿ç”¨ HKDF è¡ç”Ÿæœ€çµ‚ AES é‡‘é‘°
                const finalKeyBytes = await hkdf(
                    new Uint8Array(intermediateKeyBits),
                    32,
                    salt,
                    'AES-GCM-256-Encryption-Key'
                );

                const aesKey = await crypto.subtle.importKey(
                    'raw',
                    finalKeyBytes,
                    { name: 'AES-GCM' },
                    false,
                    ['decrypt']
                );

                // 6. è§£å¯†
                const decryptedBytes = await crypto.subtle.decrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv,
                        tagLength: 128
                    },
                    aesKey,
                    ciphertextBytes
                );

                // 7. è½‰æ›ç‚ºæ–‡å­—
                const plaintext = new TextDecoder().decode(decryptedBytes);

                showOutput(plaintext, 'success');

            } catch (error) {
                console.error('è§£å¯†éŒ¯èª¤:', error);

                // ä¸é€éœ²å…·é«”éŒ¯èª¤ç´°ç¯€ï¼Œæå‡å®‰å…¨æ€§
                if (error.name === 'OperationError' || error.message.includes('decrypt')) {
                    showOutput('è§£å¯†å¤±æ•—ï¼šå¯†ç¢¼éŒ¯èª¤æˆ–å¯†æ–‡å·²æå£', 'error');
                } else {
                    showOutput('è§£å¯†å¤±æ•—ï¼š' + error.message, 'error');
                }
            } finally {
                loading.classList.remove('active');
            }
        }

        // ============================================
        // UI è¼”åŠ©å‡½æ•¸
        // ============================================
        function clearAll() {
            document.getElementById('content-input').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('password-strength-bar').className = 'password-strength-bar';
            hideOutput();
        }

        async function copyToClipboard() {
            const output = document.getElementById('output');
            const text = output.textContent;

            if (!text || text.includes('å°‡é¡¯ç¤ºåœ¨é€™è£¡') || text.includes('è™•ç†ä¸­') || text.startsWith('âŒ')) {
                alert('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);

                // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'âœ“ å·²è¤‡è£½';
                button.style.background = '#45a049';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            } catch (err) {
                // Fallback æ–¹æ³•
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }
        }

        // ============================================
        // äº‹ä»¶ç›£è½å™¨
        // ============================================
        document.getElementById('password-input').addEventListener('input', function(e) {
            checkPasswordStrength(e.target.value);
        });

        // æŒ‰ Enter éµè§¸ç™¼è™•ç†
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processAction();
            }
        });

        document.getElementById('content-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                processAction();
            }
        });

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        console.log('ğŸ” é«˜å®‰å…¨æ€§åŠ è§£å¯†å·¥å…·å·²è¼‰å…¥');
        console.log('ç‰ˆæœ¬:', CONFIG.VERSION);
        console.log('åŠ å¯†æ¼”ç®—æ³•: AES-GCM-256');
        console.log('é‡‘é‘°è¡ç”Ÿ: PBKDF2-SHA512 (' + CONFIG.PBKDF2_ITERATIONS.toLocaleString() + ' iterations) + HKDF-SHA256');
        console.log('é›¶å¤–éƒ¨ä¾è³´ | å®Œå…¨é›¢ç·šå¯ç”¨ | å®¢æˆ¶ç«¯åŠ å¯†');
    </script>
</body>
</html>
